module.exports = async ({ github, context, tagChanges }) => {
    const owner = context.repo.owner;
    const repo = context.repo.repo;
    const prNumber = context.payload.pull_request.number;

    const commentBody = `## Normative Rule Changes Detected

This PR modifies normatively tagged text. Please review the changes below to ensure they are intentional.

<details>
<summary>View Detected Changes</summary>

${tagChanges || 'No detailed changes available.'}

</details>

---

**What happens next:**
- This comment is informational only and does **not** block merging
- When this PR is merged, a GitHub issue will be automatically created with the \`NormRules\` label for CSC tracking
- If these changes are unintentional, please update the PR before merging

**How to update reference files (if needed):**
\`\`\`bash
make update-ref
git add ref/*.json
git commit -m "Update normative tag reference files"
\`\`\`

> **Note:** New tags (additions) are automatically added to the reference files when PRs are merged to main. Only modifications and deletions require manual review.

*This comment was automatically generated by the normative tag check workflow.*`;

    // Check if we already commented on this PR
    const comments = await github.rest.issues.listComments({
        owner,
        repo,
        issue_number: prNumber
    });

    const existingComment = comments.data.find(comment =>
        comment.user.login === 'github-actions[bot]' &&
        comment.body.includes('Normative Rule Changes Detected')
    );

    if (existingComment) {
        // Update the existing comment
        await github.rest.issues.updateComment({
            owner,
            repo,
            comment_id: existingComment.id,
            body: commentBody
        });
        console.log(`Updated existing comment on PR #${prNumber}`);
    } else {
        // Create a new comment
        await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: prNumber,
            body: commentBody
        });
        console.log(`Added comment to PR #${prNumber}`);
    }
};
